# Netgear MR1100 Router Monitor - Project Context

## Project Overview
A beautiful, interactive Node.js CLI dashboard that monitors and displays real-time statistics from a Netgear Nighthawk M1 (MR1100) router. The service queries the router's internal API every 5 seconds and displays network status, bandwidth usage with ASCII histograms, and connected devices.

## Key Files
- `router-stats.js` - Main monitoring service (600+ lines) with SQLite integration
- `package.json` - NPM configuration with scripts and dependencies
- `router-stats.db` - SQLite database (bandwidth history + settings)
- `README.md` - Complete documentation
- `.gitignore` - Excludes database files and node_modules

## Router API Details

### Authentication Flow
1. Initialize session: `GET /sess_cd_tmp` → receives `sessionId` cookie
2. Get security token: `GET /api/model.json?internalapi=1` → extract `session.secToken`
3. Login: `POST /Forms/config` with `session.password=<PASSWORD>&token=<TOKEN>`
4. All subsequent requests use the session cookie

**Automatic Re-authentication**:
- Detects session expiration (HTML login page instead of JSON response)
- Automatically re-initializes session and logs in
- Retries failed request after successful re-auth
- Handles network errors gracefully (EHOSTUNREACH, ENETUNREACH, ECONNRESET)
- Shows clear status messages: "⟳ Session expired, re-authenticating..." → "✓ Re-authentication successful"

### Main API Endpoint
`GET http://192.168.2.1/api/model.json?internalapi=1&x=<timestamp>`

Returns comprehensive JSON with:
- `wwan` - Network status, signal strength (RSRP/RSRQ/SINR), connection type, data transferred
- `wwanadv` - Advanced network info (LTE band, cell ID, etc.)
- `wwan.dataUsage.generic` - Contains `dataTransferred` and `dataTransferredRoaming` for lifetime usage
- `router.clientList` - Connected devices with IP/MAC/name
- `wifi` - WiFi status for primary and guest networks
- `general` - Device temperature, uptime, model info
- `power` - Power status, battery info

## Implementation Details

### Display Structure
- **Header**: 76 chars wide (fixed, no emojis to avoid alignment issues)
- **Panels**: 76 chars wide with Unicode box drawing (┌─┐│└─┘)
- **Bar graphs**: 35 chars wide max to prevent overflow

### Color Scheme
- Cyan: Downloads
- Magenta: Uploads
- Yellow: Totals/highlights
- Green: Good status
- Red/Yellow: Temperature warnings
- Dim: Secondary info

### Interactive Features
Keyboard shortcuts with instant refresh:
- `[n]` - Toggle Network panel
- `[b]` - Toggle Bandwidth panel
- `[h]` - Toggle History histogram
- `[d]` - Toggle Device/WiFi panel
- `[v]` - Toggle Verbose device list
- `[q]` - Quit

### Bandwidth History
- Stores last 20 samples of download/upload speeds in SQLite database
- Persists across restarts with proper time context
- Creates ASCII histogram with 5-row height
- Uses special chars: █ (full), ▄ (half), ▁ (bottom)
- Shows after 5+ samples collected
- Auto-cleanup of data older than 7 days

### Database Persistence (SQLite)
- **Dependencies**: `better-sqlite3` (^12.4.1)
- **Database file**: `router-stats.db` (auto-created on first run)
- **Tables**:
  - **`timeseries_data`** (PRIMARY) - Stores raw byte counters with timestamps for accurate speed calculation across restarts
    - Fields: timestamp, total_rx_bytes, total_tx_bytes, session_duration, signal_rsrp, signal_rsrq, signal_sinr
    - Indexed by timestamp DESC for fast queries
    - **Key advantage**: Can calculate accurate speeds between any two data points, even across service restarts
  - `bandwidth_history` (LEGACY) - Stores pre-calculated download_speed, upload_speed (kept for backward compatibility)
  - `settings` - Stores display options as JSON key-value pairs
- **Functions**:
  - `initDatabase()` - Creates tables and indexes (lines 50-86)
  - `saveTimeseriesData(timestamp, totalRx, totalTx, sessionDuration, signalRsrp, signalRsrq, signalSinr)` - Saves raw router data (lines 132-140)
  - `calculateSpeedsFromTimeseries(limit)` - Calculates speeds from timeseries data, returns {download, upload, timestamps} arrays (lines 142-193)
    - Gets last N+1 records to calculate N speed deltas
    - Handles router resets (skips negative byte differences)
    - Returns proper time-contextualized speeds
  - `saveBandwidthData(downloadSpeed, uploadSpeed)` - Saves to legacy table (lines 88-93)
  - `loadBandwidthHistory(maxSamples)` - Loads from legacy table (lines 95-109)
  - `saveSettings()` - Persists display options to DB (lines 111-116)
  - `loadSettings()` - Restores display options on startup (lines 118-130)
  - `cleanOldData(days)` - Removes records older than N days from BOTH tables (lines 195-210)
- **Startup behavior**: Prefers timeseries data, falls back to legacy if not available
  - Message: "✓ Loaded X historical bandwidth samples from timeseries data" (timeseries)
  - Message: "✓ Loaded X historical bandwidth samples (legacy)" (legacy fallback)
- **Auto-save**: Settings saved on every keyboard toggle
- **Git**: Database files excluded in `.gitignore`

## Configuration
Located at top of `router-stats.js`:
```javascript
const ROUTER_IP = '192.168.2.1';
const USERNAME = 'admin';
const PASSWORD = 'adaniel';
const POLL_INTERVAL = 5000; // 5 seconds
```

## Display Options (toggleable via keyboard)
```javascript
displayOptions = {
  showNetwork: true,     // Network connection info
  showBandwidth: true,   // Data usage & bandwidth
  showDevice: false,     // Device/WiFi status (hidden by default)
  showVerbose: false,    // Detailed device list (hidden by default)
  showHistory: false     // Bandwidth histogram (hidden by default)
}
```

## NPM Scripts
- `npm start` / `npm run monitor` - Standard mode
- `npm run verbose` - Start with verbose mode enabled

## Common Tasks

### Adjusting Panel Width
All panels use 76-char width. To change:
1. Update header box chars (line 250-254)
2. Update panel title lines (e.g., line 262, 279)
3. Adjust bar widths in `createDataBar()` and `createBarGraph()` calls

### Adding New Stats
1. Extract data from API response in `displayStats()`
2. Add to appropriate panel or create new panel
3. Ensure panel closing `└─┘` aligns with opening `┌─┐`
4. Keep total width at 76 chars

### Modifying Bar Graphs
- `createBarGraph(label, value, maxValue, width, color)` - For bandwidth speeds
- `createDataBar(label, current, total, width, color)` - For data usage percentages
- Default width is 35 chars - adjust carefully to prevent overflow

### Database Maintenance
**View timeseries data** (preferred method):
```bash
# Count records
sqlite3 router-stats.db "SELECT COUNT(*) FROM timeseries_data"

# View recent data with human-readable timestamps
sqlite3 router-stats.db "SELECT datetime(timestamp/1000, 'unixepoch') as time,
  ROUND(total_rx_bytes/1024/1024, 2) as rx_mb,
  ROUND(total_tx_bytes/1024/1024, 2) as tx_mb,
  session_duration, signal_rsrp, signal_rsrq, signal_sinr
FROM timeseries_data ORDER BY timestamp DESC LIMIT 10"

# Calculate speeds from timeseries
sqlite3 router-stats.db "WITH speed_calc AS (
  SELECT
    datetime(timestamp/1000, 'unixepoch') as time,
    total_rx_bytes,
    total_tx_bytes,
    LAG(total_rx_bytes) OVER (ORDER BY timestamp) as prev_rx,
    LAG(total_tx_bytes) OVER (ORDER BY timestamp) as prev_tx,
    LAG(timestamp) OVER (ORDER BY timestamp) as prev_time,
    timestamp
  FROM timeseries_data ORDER BY timestamp DESC LIMIT 10
)
SELECT time,
  ROUND((total_rx_bytes - prev_rx) / ((timestamp - prev_time) / 1000.0) / 1024 / 1024, 2) as dl_mbps,
  ROUND((total_tx_bytes - prev_tx) / ((timestamp - prev_time) / 1000.0) / 1024, 2) as ul_kbps
FROM speed_calc WHERE prev_rx IS NOT NULL"
```

**View legacy bandwidth_history**:
```bash
sqlite3 router-stats.db "SELECT COUNT(*) FROM bandwidth_history"
sqlite3 router-stats.db "SELECT datetime(timestamp/1000, 'unixepoch') as time, download_speed, upload_speed FROM bandwidth_history ORDER BY timestamp DESC LIMIT 10"
```

**View settings**:
```bash
sqlite3 router-stats.db "SELECT * FROM settings"
```

**Reset database** (if corrupted or to start fresh):
```bash
rm router-stats.db router-stats.db-shm router-stats.db-wal
# Database will be recreated on next run
```

**Export data for analysis**:
```bash
# Export timeseries data
sqlite3 router-stats.db -header -csv "SELECT
  datetime(timestamp/1000, 'unixepoch') as time,
  total_rx_bytes, total_tx_bytes, session_duration,
  signal_rsrp, signal_rsrq, signal_sinr
FROM timeseries_data ORDER BY timestamp" > timeseries_export.csv

# Export legacy speeds
sqlite3 router-stats.db -header -csv "SELECT * FROM bandwidth_history" > bandwidth_export.csv
```

**Change data retention period**:
Edit `router-stats.js` line ~655 to change from 7 days:
```javascript
cleanOldData(30); // Keep 30 days instead of 7
```

## Known Constraints
- Emojis count as 1 char but render as 2 chars wide - avoid in dynamic content
- Router API requires fresh session for each run (cookies expire)
- Bandwidth calculation requires 2+ polling cycles (first cycle shows 0)
- Histogram requires 5+ samples to display

## Testing

### Manual Tests
1. **Quick test**: `node router-stats.js` (Ctrl+C to exit)
2. **Full test with history**: Let run for 30+ seconds, press `[h]` to see histogram
3. **Database persistence**:
   - Run service, let collect data, press Ctrl+C
   - Restart service - should show "✓ Loaded X historical bandwidth samples"
   - Press `[h]` to verify historical data displays correctly

### Recommended Test Suite
Consider adding automated tests for:

**Database Operations**:
- `initDatabase()` creates tables correctly
- `saveBandwidthData()` inserts records with correct timestamp
- `loadBandwidthHistory()` returns data in correct order (oldest → newest)
- `saveSettings()` / `loadSettings()` persist display options correctly
- `cleanOldData()` removes records older than N days
- Database handles concurrent writes during rapid polling

**Router API**:
- Session initialization receives valid sessionId cookie
- Login returns success status with valid token
- API requests handle network timeouts gracefully
- Authentication refresh when session expires
- Handle router offline/unreachable scenarios

**Bandwidth Calculation**:
- Correct speed calculation from byte deltas
- Handles first poll (no previous data) correctly
- Units conversion (bytes → KB → MB → GB) accurate
- Handles counter rollover (if router resets)

**Display Formatting**:
- All panels maintain 76-char width
- Bar graphs scale correctly with various data sizes
- Histogram renders properly with edge cases (all zeros, single spike, etc.)
- Unicode box drawing aligns correctly
- Emoji handling doesn't break alignment

**Keyboard Input**:
- All toggle keys work correctly
- Settings persist after toggle
- Instant refresh occurs on key press
- Quit command closes database connection properly

**Data Integrity**:
- No data loss during rapid keyboard toggles
- Database transactions complete before shutdown
- Corrupted database recovery
- Disk space handling when database grows

### Testing Commands
```bash
# Check database contents
sqlite3 router-stats.db "SELECT COUNT(*) FROM bandwidth_history"
sqlite3 router-stats.db "SELECT * FROM bandwidth_history ORDER BY timestamp DESC LIMIT 5"
sqlite3 router-stats.db "SELECT * FROM settings"

# Check database size
ls -lh router-stats.db

# Verify npm scripts
npm start
npm run verbose

# Test keyboard shortcuts (while running)
# Press: n, b, h, d, v to toggle sections
# Press: q to quit
```

## Future Enhancements
- Add data export to JSON/CSV for external analysis
- Add alert thresholds for signal/temp (desktop notifications)
- Multiple router support (config file with router profiles)
- Web dashboard interface (serve stats via HTTP)
- Data aggregation (hourly/daily averages)
- SMS notifications for critical issues
